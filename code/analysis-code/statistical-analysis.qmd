---
title: "Statistical Analysis"
author: "Ranni Tewfik"
date: "03/15/2024"
output: html_document
---

  
# Statistical Analysis

This statistical analysis script loads the processed data and does statistical analysis.


# Load and Check Processed Data

```{r}
# Load required packages
library(here)
library(dplyr)
library(skimr)
library(survival)
library(survminer)
library(ggplot2)
library(tidyverse)
library(gtsummary)
library(car)
library(broom)

# Load processed data
seer <- readRDS(here("data/processed-data/processeddata.rds"))

# Attach processed data
attach(seer)

# Summary of processed data
glimpse(seer)
summary(seer)
head(seer)
```


# Proportional Hazards Assessment

```{r}
# Create a log-log survival curve for "ethnicity"
plot(survfit(Surv(survival_time, death) ~ ethnicity), fun = "cloglog")

# Save the log-log survival curve for "ethnicity"
png(here("results/figures/loglogcurve_ethnicity.png"))
plot(survfit(Surv(survival_time, death) ~ ethnicity), fun = "cloglog")
dev.off()

# Create a log-log survival curve for "agegroup"
plot(survfit(Surv(survival_time, death) ~ agegroup), fun = "cloglog")

# Save the log-log survival curve for "agegroup"
png(here("results/figures/loglogcurve_age.png"))
plot(survfit(Surv(survival_time, death) ~ agegroup), fun = "cloglog")
dev.off()

# Create a log-log survival curve for "stage"
plot(survfit(Surv(survival_time, death) ~ stage), fun = "cloglog")

# Save the log-log survival curve for "stage"
png(here("results/figures/loglogcurve_stage.png"))
plot(survfit(Surv(survival_time, death) ~ stage), fun = "cloglog")
dev.off()
```


The log-log survival curves to test the proportional-hazards assumption for the Cox proportional-hazards model can be found in the "figures" folder.


```{r}
# Fit the Cox proportional-hazards model using "ethnicity" as the predictor 
simple_model <- coxph(formula = Surv(survival_time, death) ~ relevel(factor(ethnicity), ref = "White"), data = seer, method = "breslow")
summary(simple_model)

# Place the results from the model fitting into a data frame with the tidy function
simple_model_table <- tidy(simple_model)

# Look at the table with the results from the model fitting
print(simple_model_table)

# Save the table with the results from the model fitting 
saveRDS(simple_model_table, file = here("results/tables/simple_model_table.rds"))

# Place the exponentiated coefficients (hazard ratios) and confidence intervals from the model fitting into a data frame 
coxsummary <- summary(simple_model)
hr <- coxsummary$conf.int

simple_model_table_hr <- data.frame(
  "Characteristic" = c("Asian", "Black", "Hispanic", "Other"),
  "Hazard ratio" = hr[, 1],
  "95% CI (lower)" = hr[, 3],
  "95% CI (upper)" = hr[, 4]
  )

# Look at the table with hazard ratios and confidence intervals
print (simple_model_table_hr)

# Save the table with hazard ratios and confidence intervals
saveRDS(simple_model_table_hr, file = here("results/tables/simple_model_table_hr.rds"))
```


The results from the model fitting using only "ethnicity" as the predictor ("simple_model_table.rds" and ""simple_model_table_hr.rds") can be found in the "tables" folder.


```{r}
# Fit the Cox proportional-hazards model using "ethnicity", "agegroup", and "stage" as the predictors
full_model <- coxph(formula = Surv(survival_time, death) ~ relevel(factor(ethnicity), ref = "White") + relevel(factor(agegroup), ref = "0-49 years") + relevel(factor(stage), ref = "Localized"), data = seer, method = "breslow")
summary(full_model)

# Place the results from the model fitting into a data frame with the tidy function
full_model_table <- tidy(full_model)

# Look at the table with the results from the model fitting
print(full_model_table)

# Save the table with the results from the model fitting 
saveRDS(full_model_table, file = here("results/tables/full_model_table.rds"))

# Place the exponentiated coefficients (hazard ratios) and confidence intervals from the model fitting into a data frame 
coxsummary <- summary(full_model)
hr <- coxsummary$conf.int

full_model_table_hr <- data.frame(
  "Characteristic" = c("Asian", "Black", "Hispanic", "Other", "50-59 years", "60-69 years", "70-79 year", "80+ years", "Distant", "Regional"),
  "Adjusted hazard ratio" = hr[, 1],
  "95% CI (lower)" = hr[, 3],
  "95% CI (upper)" = hr[, 4]
  )

# Look at the table with hazard ratios and confidence intervals
print (full_model_table_hr)

# Save the table with hazard ratios and confidence intervals
saveRDS(full_model_table_hr, file = here("results/tables/full_model_table_hr.rds"))
```


The results from the model fitting using "ethnicity", "agegroup", and "stage" as the predictors ("full_model_table.rds" and "full_model_table_hr.rds") can be found in the "tables" folder.

